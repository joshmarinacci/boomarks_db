<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<h1>Add Bookmark</h1>
<form id="bookmark">
    <label>
        auth code
        <input type="text" id="authcode">
    </label>
    <label>
        URL
        <input type="text" name="url" id="url">
    </label>
    <button id="save">save</button>
</form>

<h1>current bookmarks</h1>
<button id="load">load</button>
<h3>bookmarks</h3>
<ul id="processed"></ul>
<h3>queue</h3>
<ul id="bookmarks"></ul>

<script>
    const $ = (sel) => document.querySelector(sel)
    const on = (el,type,cb) => el.addEventListener(type,cb)
    console.log("doing the form")
    on($("#save"),'click',(e)=>{
        console.log("saving the form")
        let data = {
            url: $("#url").value,
            authcode:$("#authcode").value,
        }
        e.preventDefault()
        fetch('./',{
            method:'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        }).then(resp => resp.json())
            .then(res => console.log('yay',res))
            .catch(e => console.error('error',e))

    })


    function render_bookmarks(target,result) {
        console.log("data is",result)
        console.log("item count",result.data.length)
        // result.data.sort((a,b)=>a.data.created - b.data.created)
        let html = result.data.map(item => {
            console.log("item is",item.data)
            let pdf_link = ""
            if(item.data.pdf) {
                pdf_link = `<a href="../../bookmark/${item.id}/attachment/pdf">full page (pdf)</a>`
            }
            let thumb = ""
            if(item.data.thumb) {
                thumb = `<a href="../../bookmark/${item.id}/attachment/thumb">
                    <img src="../../bookmark/${item.id}/attachment/thumb" width="256"/></a>`
            }
            if(item.data.title) {
                return `<li>
                        <a href="${item.data.url}">${item.data.title}</a>
                        <p>${item.data.excerpt?item.data.excerpt:"no excerpt"}</p>
                        <p>${pdf_link}</p>
                        <p>${thumb}</p>
                        </li>`
            } else {
                return `<li><a href='${item.data.url}' target="_blank">${item.data.url}</a></li>`
            }
        }).join("\n")
        // console.log("html is",html)
        target.innerHTML = html
    }
    on($("#load"),'click',() => {
        let url = "http://localhost:3000/bookmarks/queue"
        fetch(url)
            .then(d => d.json())
            .then((data)=>render_bookmarks($("#bookmarks"),data))
        fetch("../../bookmarks/processed")
            .then(d => d.json())
            .then((data)=>render_bookmarks($("#processed"),data))
    })

</script>
</body>
</html>
